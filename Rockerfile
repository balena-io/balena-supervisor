# Build nodejs dependencies
FROM resin/{{ .Arch }}-node:6.2-slim

WORKDIR /usr/src/app

RUN apt-get update \
	&& apt-get install -y \
		g++ \
		libsqlite3-dev \
		make \
		python \
	&& rm -rf /var/lib/apt/lists/ \
	&& npm install -g coffee-script

COPY package.json /usr/src/app/

RUN JOBS=MAX npm install --unsafe-perm --production --no-optional \
	&& npm dedupe

COPY src /usr/src/app/src

RUN coffee -c src

# Remove tar files (sqlite3 module) and tests to reduce space
RUN find . -name '*.tar.*' -delete \
    && find . -path '*/test/*' -delete

EXPORT /usr/src/app/node_modules/ node_modules/
EXPORT /usr/src/app/src/ src/

# Build golang supervisor
FROM golang:1.5.1

COPY gosuper /go/src/resin-supervisor/gosuper

WORKDIR /go/src/resin-supervisor/gosuper

ENV GOOS linux
ENV GOARCH {{ .Arch }}

RUN go install -a -v ./gosuper

EXPORT /go/bin/gosuper gosuper

# Minimal runtime image
FROM resin/{{ .Arch }}-supervisor-base

COPY package.json /usr/src/app/

IMPORT src/ /usr/src/app/src/

IMPORT node_modules/ /usr/src/app/node_modules/

IMPORT gosuper /usr/bin/gosuper

ENTRYPOINT [ "/sbin/init" ]

VOLUME /data

ENV CONFIG_MOUNT_POINT /boot/config.json
ENV DEFAULT_MIXPANEL_TOKEN bananasbananas
ENV DEFAULT_PUBNUB_PUBLISH_KEY pub-c-bananas
ENV DEFAULT_PUBNUB_SUBSCRIBE_KEY sub-c-bananas
ENV LED_FILE /dev/null
ENV SUPERVISOR_IMAGE resin/{{ .Arch }}-supervisor

TAG resin/{{ .Arch }}-supervisor:master

# -*- mode: dockerfile -*-
# vi: set ft=dockerfile :
